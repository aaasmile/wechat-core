stages:
  - build
  - push
  - deploy
  - release
  - cleanup

#开发环境打包发布
build-dev:
  stage: build
  only:
    - dev
  tags:
    - shell-build-dev
  script:
    - mvn -Dmaven.test.skip=true clean package
    
push-dev:
  stage: push
  only:
    - dev
  tags:
    - shell-build-dev
  script:
    - mvn docker:push

deploy-dev:
  stage: deploy
  only:
    - dev
  tags:
    - shell-deploy-dev
  script:
    - cd /root/docker-swarm/
    - docker stack deploy -c wechat1.yml wechat1

#部署UAT    
deploy-uat:
  stage: deploy
  only:
    - uat
  tags:
    - shell-deploy-qa
  script:
    - cd /root/docker-swarm/
    - docker stack deploy -c wechat1.yml wechat1

#打标签    
release-job:
  stage: release
  script:
    - docker tag docker.d1m.cn/wechat-core:latest docker.d1m.cn/wechat-core:$CI_COMMIT_TAG
    - docker push docker.d1m.cn/wechat-core:$CI_COMMIT_TAG
  only:
    - tags

#解决BUG
issues-build:
  stage: build
  only:
    - /^issue-.*$/
  tags:
    - issues-build-dev
  script:
    - mvn -Dmaven.test.skip=true clean package
    
issues-push:
  stage: push
  only:
    - /^issue-.*$/
  tags:
    - issues-build-dev
  script:
    - mvn docker:push    
    
issues-deploy:
  stage: deploy
  only:
    - /^issue-.*$/
  tags:
    - issues-deploy-dev
  script:
    - cd /root/docker-swarm/
    - docker stack deploy -c wechat1.yml wechat1

#清理    
cleanup-job:
  tags:
    - docker
  stage: cleanup
  script:
    - docker rm -v build_data_$CI_PROJECT_ID_$CI_BUILD_REF
    - docker rmi ci-project-build-$CI_PROJECT_ID:$CI_BUILD_REF
  when: always
